<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Mapping Tool - Wireframe</title>
    <link rel="stylesheet" href="system_mapping.css">
    <style>
        .parent-node-select-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="logo-section">
            <div class="logo">S</div>
            <div class="project-name">System Map</div>
        </div>
        
        <div class="top-actions">
            <button class="action-btn">Export</button>
            <button class="action-btn">Share</button>
            <button class="action-btn">Save</button>
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Side Panel -->
        <div class="side-panel" id="sidePanel">
            <button class="expand-btn" onclick="togglePanel()">â€º</button>
            
            <div class="panel-header">
                <div class="panel-title">Tools</div>
                <button class="collapse-btn" onclick="togglePanel()">â€¹</button>
            </div>
            
            <div class="panel-content">
                <div class="tool-section">
                    <h3>Add Nodes</h3>
                    <div class="tool-item" onclick="selectTool('node')">
                        <div class="tool-icon"></div>
                        <div class="tool-text">Node</div>
                    </div>
                    <div class="tool-item" onclick="selectTool('edit')">
                        <div class="tool-icon"></div>
                        <div class="tool-text">Edit Node</div>
                    </div>
                </div>

                <!-- Add Node Configuration Section -->
                <div class="node-config" id="nodeConfig">
                    <div class="config-field">
                        <label class="config-label">Name</label>
                        <input type="text" class="config-input" placeholder="Enter node name">
                    </div>
                    
                    <div class="config-field">
                        <label class="config-label">Type</label>
                        <select class="config-select">
                            <option value="">Select type</option>
                            <option value="hardware">Hardware</option>
                            <option value="service">Service</option>
                        </select>
                    </div>
                    
                    <!-- Parent Node Select -->
                    <div class="config-field">
                        <label class="config-label">Parent Node</label>
                        <div class="parent-node-row">
                            <div id="parentNodeContainer">
                                <div class="parent-node-select-row">
                                    <select class="config-select parent-node-select">
                                        <option value="">Select parent node</option>
                                        <!-- Dynamically populated -->
                                    </select>
                                </div>
                                <!-- Additional parent selects will be added here dynamically -->
                            </div>
                            <button class="add-parent-btn add-attribute-btn" type="button" onclick="addParentNodeSelect()">+</button>
                        </div>
                    </div>

                    <!-- Custom Attributes Section -->
                    <div class="custom-attributes">
                        <div class="attributes-header">
                            <span class="attributes-title">Custom Attributes</span>
                        </div>
                        <div id="attributesList">
                            <!-- Dynamic attributes will be added here -->
                        </div>
                        <button class="add-attribute-btn" onclick="addAttribute()">+</button>
                    </div>

                    <!-- Save Button -->
                    <button class="save-node-btn" onclick="saveNode()">Save Node</button>
                </div>

                <!-- Edit Node Configuration Section -->
                <div class="edit-node-config" id="editNodeConfig">
                    <div class="config-field">
                        <label class="config-label">Select Node</label>
                        <select class="config-select" id="editNodeSelect" onchange="populateEditNodeAttributes()">
                            <option value="">Select node</option>
                            <!-- Dynamically populated -->
                        </select>
                    </div>
                    <div id="editAttributesList">
                        <!-- Editable attributes will appear here -->
                    </div>
                    <button class="add-attribute-btn" onclick="addEditAttribute()">+</button>
                    <button class="save-node-btn" onclick="saveEditedNode()">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            
            <!-- D3 Graph Visualization -->
            <div id="graph" class="d3-graph"></div>
            <svg></svg>
            <div class="tooltip" style="opacity:0"></div>
            <script src="https://d3js.org/d3.v7.min.js"></script>
            <script type="module">
                import { data } from './topology.js';
            
                const width = window.innerWidth;
                const height = window.innerHeight;
            
                const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
                const tooltip = d3.select(".tooltip");
            
                const svg = d3.select("svg")
                .attr("viewBox", [0, 0, width, height]);
            
                const LXC = svg.append("g");
            
                svg.call(d3.zoom().on("zoom", ({transform}) => {
                LXC.attr("transform", transform);
                }));
            
                const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(120))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2));
            
                const link = LXC.append("g")
                .attr("stroke", "#aaa")
                .attr("stroke-opacity", 0.6)
                .selectAll("line")
                .data(data.links)
                .join("line")
                .attr("stroke-width", 1.5);
            
                const node = LXC.append("g")
                .attr("stroke", "#fff")
                .attr("stroke-width", 1.5)
                .selectAll("circle")
                .data(data.nodes)
                .join("circle")
                .attr("r", 10)
                .attr("fill", d => colorScale(d.group))
                .call(drag(simulation))
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`<strong>${d.id}</strong><br/>Group: ${d.group}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY + 10) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(200).style("opacity", 0);
                });
            
                const label = LXC.append("g")
                .selectAll("text")
                .data(data.nodes)
                .join("text")
                .text(d => d.id)
                .attr("x", 12)
                .attr("y", "0.31em")
                .attr("fill", "#ccc")
                .style("font-size", "0.75rem");
            
                simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
            
                node.attr("cx", d => d.x)
                    .attr("cy", d => d.y);
            
                label.attr("x", d => d.x + 12)
                    .attr("y", d => d.y);
                });
            
                function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
                }

                // Populate parent node select options
                const parentNodeSelects = document.querySelectorAll('.parent-node-select');
                parentNodeSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select parent node</option>';
                    data.nodes.forEach(node => {
                        const option = document.createElement('option');
                        option.value = node.id;
                        option.textContent = node.id;
                        select.appendChild(option);
                    });
                });

                // Populate the edit node dropdown on page load
                document.addEventListener('DOMContentLoaded', () => {
                    const editNodeSelect = document.getElementById('editNodeSelect');
                    if (editNodeSelect) {
                        import('./topology.js').then(module => {
                            const nodes = module.data.nodes;
                            nodes.forEach(node => {
                                const option = document.createElement('option');
                                option.value = node.id;
                                option.textContent = node.id;
                                editNodeSelect.appendChild(option);
                            });
                        });
                    }
                });

                // Populate attributes for editing
                function populateEditNodeAttributes() {
                    const editNodeSelect = document.getElementById('editNodeSelect');
                    const editAttributesList = document.getElementById('editAttributesList');
                    editAttributesList.innerHTML = '';
                    const selectedId = editNodeSelect.value;
                    if (!selectedId) return;

                    import('./topology.js').then(module => {
                        const node = module.data.nodes.find(n => n.id === selectedId);
                        if (!node) return;
                        (node.attributes || []).forEach(attr => {
                            addEditAttribute(attr.name, attr.value);
                        });
                    });
                }
                window.populateEditNodeAttributes = populateEditNodeAttributes;

                // Save edited node attributes
                function saveEditedNode() {
                    const editNodeSelect = document.getElementById('editNodeSelect');
                    const selectedId = editNodeSelect.value;
                    if (!selectedId) return;

                    import('./topology.js').then(module => {
                        const node = module.data.nodes.find(n => n.id === selectedId);
                        if (!node) return;
                        const editAttributesList = document.getElementById('editAttributesList');
                        const newAttributes = [];
                        editAttributesList.querySelectorAll('.attribute-item').forEach(item => {
                            const nameInput = item.querySelector('.attribute-name-input');
                            const valueInput = item.querySelector('.attribute-value-input');
                            if (nameInput.value && valueInput.value) {
                                newAttributes.push({
                                    name: nameInput.value,
                                    value: valueInput.value
                                });
                            }
                        });
                        node.attributes = newAttributes;
                        alert('Node attributes updated (in memory)');
                    });
                }
                window.saveEditedNode = saveEditedNode;
            </script>
            <div class="canvas-grid"></div>

            <!-- Canvas Controls -->
            <!-- <div class="canvas-controls">
                <button class="control-btn">+</button>
                <button class="control-btn">-</button>
                <button class="control-btn">âŒ‚</button>
                <button class="control-btn">âŸ²</button>
            </div> -->
        </div>
    </div>

    <script>
        function togglePanel() {
            const panel = document.getElementById('sidePanel');
            const collapseBtn = panel.querySelector('.collapse-btn');
            
            panel.classList.toggle('collapsed');
            collapseBtn.innerHTML = panel.classList.contains('collapsed') ? 'â€¹' : 'â€¹';
        }

        function selectTool(tool) {
            // Remove active state from all items
            document.querySelectorAll('.tool-item').forEach(i => {
                i.style.background = '';
                i.style.borderColor = '';
            });

            const nodeConfig = document.getElementById('nodeConfig');
            const editNodeConfig = document.getElementById('editNodeConfig');

            // Toggle panels based on tool
            if (tool === 'node') {
                if (nodeConfig.classList.contains('active')) {
                    nodeConfig.classList.remove('active');
                    return;
                }
                nodeConfig.classList.add('active');
                editNodeConfig.classList.remove('active');
            } else if (tool === 'edit') {
                if (editNodeConfig.classList.contains('active')) {
                    editNodeConfig.classList.remove('active');
                    return;
                }
                editNodeConfig.classList.add('active');
                nodeConfig.classList.remove('active');
            }
            // Highlight the clicked tool
            event.target.closest('.tool-item').style.background = document.body.classList.contains('dark') ? '#333' : '#e3f2fd';
            event.target.closest('.tool-item').style.borderColor = document.body.classList.contains('dark') ? '#667eea' : '#667eea';
        }

        function addAttribute() {
            const attributesList = document.getElementById('attributesList');

            // Create the attribute row
            const attributeDiv = document.createElement('div');
            attributeDiv.className = 'attribute-item';

            // Create the name row
            const nameRow = document.createElement('div');
            nameRow.className = 'attribute-name-row';

            // Name input
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'attribute-name-input';
            nameInput.placeholder = 'Attribute name';

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-attribute-btn';
            removeBtn.textContent = 'âˆ’';
            removeBtn.onclick = function() {
                attributeDiv.remove();
            };

            nameRow.appendChild(nameInput);
            nameRow.appendChild(removeBtn);

            // Value textarea
            const valueInput = document.createElement('textarea');
            valueInput.className = 'attribute-value-input';
            valueInput.placeholder = 'Enter attribute value (can be multiple lines)';

            // Assemble
            attributeDiv.appendChild(nameRow);
            attributeDiv.appendChild(valueInput);

            attributesList.appendChild(attributeDiv);
        }
        window.addAttribute = addAttribute;

        function removeAttribute(attributeId) {
            const attributeElement = document.getElementById(attributeId);
            if (attributeElement) {
                attributeElement.remove();
            }
        }
        window.removeAttribute = removeAttribute;

        function saveNode() {
            // Collect form data
            const parentNodeValues = Array.from(document.querySelectorAll('.parent-node-select'))
                .map(sel => sel.value)
                .filter(val => val);

            const nodeData = {
                name: document.querySelector('.node-config input[placeholder="Enter node name"]').value,
                type: document.querySelector('.node-config select').value,
                parentNodes: parentNodeValues,
                attributes: []
            };

            // Collect custom attributes
            document.querySelectorAll('.attribute-item').forEach(item => {
                const nameInput = item.querySelector('.attribute-name-input');
                const valueInput = item.querySelector('.attribute-value-input');
                if (nameInput.value && valueInput.value) {
                    nodeData.attributes.push({
                        name: nameInput.value,
                        value: valueInput.value
                    });
                }
            });

            // Simulate saving (in real app, this would call your API)
            console.log('Saving node:', nodeData);
            
            // Show success feedback
            const saveBtn = document.querySelector('.save-node-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            saveBtn.style.background = '#28a745';
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 1500);

            // Clear form fields
            document.querySelector('.node-config input[placeholder="Enter node name"]').value = '';
            document.querySelector('.node-config select').selectedIndex = 0;
            document.querySelectorAll('.node-config select')[1].selectedIndex = 0;
            document.getElementById('attributesList').innerHTML = '';

            // In a real app, you would update the D3.js visualization here
            // For demo purposes, we'll just log it
            console.log('Would update D3.js visualization with new node');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const btn = document.querySelector('.theme-toggle');
            btn.innerHTML = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        function addParentNodeSelect() {
            const container = document.getElementById('parentNodeContainer');
            const selects = container.querySelectorAll('.parent-node-select');
            // Clone the first select
            const newSelect = selects[0].cloneNode(true);
            newSelect.selectedIndex = 0;

            // Wrap in a row div
            const rowDiv = document.createElement('div');
            rowDiv.className = 'parent-node-select-row';
            rowDiv.appendChild(newSelect);

            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-parent-btn';
            removeBtn.textContent = 'âˆ’';
            removeBtn.onclick = function() {
                rowDiv.remove();
            };
            rowDiv.appendChild(removeBtn);

            container.appendChild(rowDiv);

            updateRemoveParentButtons();
        }

        // Ensure only additional selects have remove buttons
        function updateRemoveParentButtons() {
            const container = document.getElementById('parentNodeContainer');
            const rows = container.querySelectorAll('.parent-node-select-row');
            rows.forEach((row, idx) => {
                const btn = row.querySelector('.remove-parent-btn');
                if (btn) btn.style.display = idx === 0 ? 'none' : '';
            });
        }

        // On page load, wrap the initial select in a row div
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('parentNodeContainer');
            const firstSelect = container.querySelector('.parent-node-select');
            if (firstSelect && !firstSelect.parentElement.classList.contains('parent-node-select-row')) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'parent-node-select-row';
                rowDiv.appendChild(firstSelect);
                container.appendChild(rowDiv);
            }
            updateRemoveParentButtons();
        });
    </script>
</body>
</html>